<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>卡券管理</title>
        <meta name="keywords" content="index">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="renderer" content="webkit">
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="apple-mobile-web-app-title" content="Amaze UI" />
        <link rel="stylesheet" href="../assets/css/amazeui.min.css" />
        <link rel="stylesheet" href="../assets/css/admin.css">
        <link rel="stylesheet" href="../assets/css/app.css">
        <style>
            .tpl-portlet-components {
                margin-top: -12px;
                border-radius: 10px;
            }
            .tpl-logo img {
                display: block;
                height: 78px;
                width: auto;
            }
            .am-popup-bd img {
                cursor: pointer;
                width: 100px;
                border-radius: 10px;
                margin: 5px;
            }
            .am-dropdown {
                float: left;
            }
            .create-card {
                width: 120px;
                height: 40px;
                border-radius: 7px;
                text-align: center;
                line-height: 40px;
                background-color: #23abf0;
                cursor: pointer;
                color: white;
                display: block;
            }
        </style>
    </head>

    <body data-type="generalComponents">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand">
                <a href="javascript:;" class="tpl-logo">
                    <img src="../assets/img/logo.png">
                </a>
            </div>

            <div class="am-collapse am-topbar-collapse" id="topbar-collapse">
                <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list tpl-header-list">
                    <li class="am-hide-sm-only">
                        <a href="javascript:;" id="admin-fullscreen" class="tpl-header-list-link">
                            <span class="am-icon-arrows-alt"></span>
                            <span class="admin-fullText">开启全屏</span>
                        </a>
                    </li>
                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="tpl-header-list-user-nick">禁言小张</span><span class="tpl-header-list-user-ico"> <img src="../assets/img/img1.png"></span>
                        </a>
                        <ul class="am-dropdown-content">
                            <li><a href="#"><span class="am-icon-power-off"></span> 退出</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </header>

        <div class="tpl-page-container tpl-page-header-fixed">
            <div class="tpl-left-nav tpl-left-nav-hover">
                <div class="tpl-left-nav-title">
                    Amaze UI 列表
                </div>
                <div class="tpl-left-nav-list">
                    <ul class="tpl-left-nav-menu">
                        <li class="tpl-left-nav-item">
                            <a href="materialImage.html" class="nav-link">
                                <i class="am-icon-home"></i>
                                <span>素材管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="poiManager.html" class="nav-link ">
                                <i class="am-icon-home"></i>
                                <span>门店管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="cardManager.html" class="nav-link tpl-left-nav-link-list active">
                                <i class="am-icon-bar-chart"></i>
                                <span>卡券管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="memberCardManager.html" class="nav-link tpl-left-nav-link-list ">
                                <i class="am-icon-bar-chart"></i>
                                <span>会员卡管理</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tpl-content-wrapper">
                <div class="tpl-portlet-components">
                    <div class="tpl-block">
                        <div class="am-g">
                            <div class="am-u-sm-12 am-u-md-3">
                                <div class="am-form-group">
                                    <select id="selectCardType" data-am-selected="{btnSize: 'sm'}">
                                        <option></option>
                                    </select>
                                </div>
                            </div>
                            <div class="am-u-sm-12 am-u-md-3">
                                <div class="am-input-group am-input-group-sm">
                                    <a href="createCard.html" class="create-card">创建卡券</a>
                                </div>
                            </div>
                        </div>

                        <div class="am-g">
                            <div class="am-u-sm-12">
                                <form class="am-form">
                                    <table class="am-table am-table-striped am-table-hover table-main">
                                        <thead>
                                            <tr>
                                                <th class="table-check"><input type="checkbox" class="tpl-table-fz-check"></th>
                                                <th class="table-title">卡券类型</th>
                                                <th class="table-title">卡券名称</th>
                                                <th class="table-type">卡券有效期</th>
                                                <th class="table-author am-hide-sm-only">卡券状态</th>
                                                <th class="table-date am-hide-sm-only">库存</th>
                                                <th class="table-set">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="showCard">

                                        </tbody>
                                    </table>
                                    <div class="am-cf">
                                        <div class="am-fr" style="font-size: 14px;">
                                            <ul class="am-pagination tpl-pagination" id="pagination"></ul>
                                        </div>
                                    </div>
                                    <hr>
                                </form>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script src="../assets/js/jquery.min.js"></script>
        <script src="../assets/js/amazeui.min.js"></script>
        <script src="../assets/js/app.js"></script>
        <script src="../assets/js/toast.js"></script>
        <script src="../assets/js/jqPaginator.min.js"></script>
        <script src="../assets/js/mytime.js"></script>
        <script type="text/javascript">
            var data = {
                pageNum : 1,// 当前页
                pageSize : 10,// 每页显示多少数据
                cardType : ''
            }

            $(function() {
                initPage()
                addItems(data.pageNum, data.pageSize)
                bindEvent()
            })
            function initPage() {
                $.ajax({
                    url : '/wechat/manager/init_card_manager_page',
                    type : 'POST',
                    dataType:'json',
                    success : function(res) {
                        var cardTypeHtml = ''
                        $.each(res, function(key, value) {
                            cardTypeHtml += '<option value="' + key + '">' + value + '</option>'
                        })
                        $('#selectCardType').append(cardTypeHtml)
                    },
                    error : function(err) {
                        console.log(err);
                    }
                })
            }
            function addItems(pageNum, pageSize) {
                var formData = new FormData();
                formData.append("pageNum", pageNum);
                formData.append("pageSize", pageSize);
                if (data.cardType != '') {
                    formData.append("cardType", data.cardType);
                }

                $.ajax({
                    url : '/wechat/manager/get_wechat_card_list_page',
                    data : formData,
                    type : 'POST',
                    dataType:'json',
                    contentType : false,
                    processData : false,
                    cache : false,
                    success : function(res) {
                        console.log(res)
                        var cardHtml = ''
                        var cardTypeStr = ''
                        var cardStatusStr = ''
                        var dateTypeStr = ''
                        var cardShelfStatusHtml = ''
                        $.each(res.data, function(index, item) {
                            //卡券类型
                            if (item.cardType === 'GENERAL_COUPON') {
                                cardTypeStr = '优惠券'
                            } else if (item.cardType === 'GIFT') {
                                cardTypeStr = '兑换券'
                            } else if (item.cardType === 'DISCOUNT') {
                                cardTypeStr = '折扣券'
                            } else if (item.cardType === 'CASH') {
                                cardTypeStr = '代金券'
                            } else if (item.cardType === 'GROUPON') {
                                cardTypeStr = '团购券'
                            } else {
                                cardTypeStr = ''
                            }
                            // 卡券状态
                            cardStatusStr = item.cardPutStatus == 1 ? "已投放" : "待投放"
                            // 时间类型
                            if (item.dateType === 'DATE_TYPE_FIX_TIME_RANGE') {
                                dateTypeStr = $.myTime.UnixToDate(item.beginTimestamp) + '到' + $.myTime.UnixToDate(item.endTimestamp) + '有效'
                            } else if (item.dateType === 'DATE_TYPE_FIX_TERM') {
                                dateTypeStr = '领取后' + item.fixedBeginTerm + '天生效' + item.fixedTerm + '天有效'
                            }

                            if (item.cardShelfStatus == 1) {
                                cardShelfStatusHtml = '<a id="shelfCardBtn" data-status="0" data-wechatcardid="' + item.cardId + '" class="am-btn am-btn-default am-btn-xs am-text-secondary"><span class="am-icon-unlock-alt"></span> 上架</a>'
                            } else if (item.cardShelfStatus == 0) {
                                cardShelfStatusHtml = '<a id="shelfCardBtn" data-status="1" data-wechatcardid="' + item.cardId + '" class="am-btn am-btn-default am-btn-xs am-text-secondary"><span class="am-icon-unlock"></span> 下架</a>'
                            }

                            cardHtml += '<tr>'+
                                '<td><input type="checkbox"></td>'+
                                '<td>' + cardTypeStr + '</td>'+
                                '<td>' + item.title + '</td>'+
                                '<td>' + dateTypeStr + '</td>'+
                                '<td class="am-hide-sm-only">' + cardStatusStr + '</td>'+
                                '<td class="am-hide-sm-only">' + item.quantity + '</td>'+
                                '<td>'+
                                '<div class="am-btn-toolbar">'+
                                '<div class="am-btn-group am-btn-group-xs">' +
                                '<a id="puttingCardBtn" data-cardid="' + item.id + '" data-wechatcardid="' + item.cardId + '" class="am-btn am-btn-default am-btn-xs am-text-secondary"><span class="am-icon-pencil-square-o"></span> 投放</a>' +
                                '<a id="deleteCardBtn" data-wechatcardid="' + item.cardId + '" class="am-btn am-btn-default am-btn-xs am-text-secondary"><span class="am-icon-trash-o"></span> 删除</a>' +
                                    cardShelfStatusHtml +
                                '</div>'+
                                '</div>'+
                                '</td>'+
                                '</tr>'
                        })
                        $('#showCard').html(cardHtml)

                        loadPage(res.totalPage, res.pageNum, res.totalCount)
                    },
                    error : function(err) {
                        console.log(err);
                    }
                })
            }
            // 加载分页信息（使用分页插件）
            function loadPage(pages, pageNum, total) {
                $.jqPaginator('#pagination', {
                    totalPages: pages,
                    visiblePages: 5,
                    currentPage: pageNum,
                    first: '<li class="first"><a href="javascript:;">首页</a></li>',
                    prev: '<li class="prev"><a href="javascript:;">上一页</a></li>',
                    next: '<li class="next"><a href="javascript:;">下一页</a></li>',
                    last: '<li class="last"><a href="javascript:;">末页</a></li>',
                    page: '<li class="page"><a href="javascript:;">{{page}}</a></li>',
                    onPageChange: function (num, type) {
                        $('#pagination').prepend('<li style="margin-right:20px;margin-left:20px;">总页数：' + pages + ' 页</li>');
                        $('#pagination').prepend('<li>总条数：' + total + ' 条</li>');
                        if (type == "change") {
                            data.pageNum = num;
                            addItems(num, data.pageSize);
                            loadPage(pages);
                        }
                    }
                });
            }
            function bindEvent() {
                // 卡券类型的选择实践
                $('#selectCardType').change(function() {
                    data.cardType = $(this).val()
                    addItems(data.pageNum, data.pageSize)
                })
                // 投放卡券
                $('body').on('click','#puttingCardBtn',function() {
                    var qrcodePuttingCard = {
                        wechatCardId : $(this).data('wechatcardid'),
                        cardId : $(this).data('cardid'),
                        actionName: 'QR_CARD'
                    }
                    $.ajax({
                        url : '/wechat/manager/qrcode_putting_card',
                        data : JSON.stringify(qrcodePuttingCard),
                        type : 'POST',
                        dataType:'json',
                        contentType:"application/json",
                        success : function(res) {
                            if (res.success) {
                                var wechatQrcodePuttingCard = res.wechatQrcodePuttingCard
                                window.location.href = '/wechat/manager/download_qrcode?url=' + wechatQrcodePuttingCard.showQrcodeUrl
                                addItems(data.pageNum, data.pageSize)
                            } else {
                                console.log(res.msg)
                                showMessage('卡券投放失败')
                            }
                        },
                        error : function(err) {
                            console.log(err);
                            showMessage('系统错误')
                        }
                    })
                })
                // 删除卡券
                $('body').on('click','#deleteCardBtn',function() {
                    if(confirm("确认删除该卡券吗")) {
                        $.ajax({
                            url : '/wechat/manager/delete_card',
                            data : {
                                cardId: $(this).data('wechatcardid')
                            },
                            type : 'POST',
                            dataType:'json',
                            success : function(res) {
                                if (res.success) {
                                    showMessage('卡券删除成功')
                                    addItems(data.pageNum, data.pageSize)
                                } else {
                                    console.log(res.msg)
                                    showMessage('卡券删除失败')
                                }
                            },
                            error : function(err) {
                                console.log(err);
                                showMessage('系统错误')
                            }
                        })
                    }
                })
                // 上架/下架卡券
                $('body').on('click','#shelfCardBtn',function() {
                    if(confirm("确认要执行该操作吗")) {
                        $.ajax({
                            url : '/wechat/manager/shelf_card',
                            data : {
                                cardId: $(this).data('wechatcardid'),
                                cardShelfStatus: $(this).data('status')
                            },
                            type : 'POST',
                            dataType:'json',
                            success : function(res) {
                                if (res.success) {
                                    showMessage('卡券操作成功')
                                    addItems(data.pageNum, data.pageSize)
                                } else {
                                    console.log(res.msg)
                                    showMessage('卡券操作失败')
                                }
                            },
                            error : function(err) {
                                console.log(err);
                                showMessage('系统错误')
                            }
                        })
                    }
                })
            }
        </script>
    </body>
</html>