<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>扫码识货</title>
        <meta name="keywords" content="index">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="renderer" content="webkit">
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="toTop" content="true">
        <link rel="icon" type="image/png" href="assets/i/favicon.png">
        <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
        <meta name="apple-mobile-web-app-title" content="Amaze UI" />
        <link rel="stylesheet" href="assets/css/amazeui.min.css" />
        <link rel="stylesheet" href="assets/css/admin.css">
        <link rel="stylesheet" href="assets/css/app.css">
        <link rel="stylesheet" href="assets/css/swiper.min.css">
        <link rel="stylesheet" href="assets/css/my_cart.css">
        <script src="assets/js/echarts.min.js"></script>
        <style>
            body {
                font-family: 'YouYuan';
            }
            .titleBox {
                float:left;
                position:relative;
                left:35%;
                height: 130px;
                line-height: 130px;
            }
            .titleBox p {
                float:left;
                position:relative;
                right:50%;
                color: black;
            }
            .returnDiv {
                font-family: Arial,'Times New Roman','Microsoft YaHei',SimHei;
                width: 120px;
                top:20px;
                right:50px;
                position:fixed;
                cursor:pointer;
            }
            .swiper-container {
                height:600px;
                margin: 20px auto;
            }
            .swiper-slide {
                text-align: center;
                font-size: 18px;
                background: #fff;

                /* Center slide text vertically */
                display: -webkit-box;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -ms-flex-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-box-align: center;
                -ms-flex-align: center;
                -webkit-align-items: center;
                align-items: center;
            }
        </style>
    </head>

    <body id="blog-article-sidebar">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand" style="height: 130px;line-height: 130px;">
                <a href="index.html" class="tpl-logo">
                    <img src="assets/img/logo.png">
                </a>
            </div>

            <div class="titleBox">
                <p class="am-text-xxxl">智能超市终端</p>
            </div>

            <div class="returnDiv">
                <a style="color: black;" href="javascript:history.back(-1)">
                    <span class="am-icon-arrow-left" style="font-size: 30px; margin-top: 10px;"></span>
                    <span style="font-size: 28px;">Return</span>
                </a>
            </div>
        </header>

        <!-- content srart -->
        <div class="am-g blog-fixed blog-content" style="margin-top: 170px;">
            <div class="am-u-sm-12" style="margin-left: 50px;">
                <article class="am-article blog-article-p">
                    <div class="am-article-hd">
                        <h1 class="am-article-title blog-text-center" style="padding-top: 0px; padding-bottom: 0px;">扫码详情</h1>
                    </div>
                    <div class="am-article-bd" style="width: 100%; ">
                        <div style="width: 600px;height: 500px;float: left">
                            <!-- Swiper -->
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide"><img src="assets/img/product01-1.jpeg"/></div>
                                    <div class="swiper-slide"><img src="assets/img/product01-2.jpg"/></div>
                                    <div class="swiper-slide"><img src="assets/img/product01-3.jpg"/></div>
                                </div>
                            </div>
                        </div>
                        <div style="float: left; max-width: 700px; margin: 20px 50px;">
                            <p class="am-article-lead" style="font-size: 27px;">
                                2018夏季新款女装时尚长裙学生条纹
                            </p>
                            <blockquote style="font-size: 20px;">
                                <p>夏装圆领韩版修身T恤短袖衫，包邮，白色</p>
                                <footer><cite>商品</cite> – 详情介绍</footer>
                            </blockquote>
                            <blockquote style="font-size: 20px;">
                                <p>￥：270</p>
                                <footer><cite>人民币</cite> – 价格</footer>
                            </blockquote>
                            <blockquote style="font-size: 20px;">
                                <p>累计销售：500件</p>
                                <footer><cite>数量</cite> – 销量</footer>
                            </blockquote>
                            <a href="#0" data-id="7" data-price="7" data-img="assets/img/product01-1.jpeg" data-name="2018夏季新款女装时尚长裙学生条纹" class="am-btn am-btn-success am-round cd-add-to-cart" style="height: 40px;width: 140px;">
                                <span class="am-icon-shopping-cart"></span>
                                购买
                            </a>
                        </div>
                    </div>
                </article>

                <!--购物车-->
                <div class="cd-cart-container empty">
                    <a href="#0" class="cd-cart-trigger">
                        Cart
                        <ul class="count">
                            <li>0</li>
                            <li>0</li>
                        </ul>
                    </a>

                    <div class="cd-cart">
                        <div class="wrapper">
                            <header style="height: 70px; line-height: 70px">
                                <h2 style="font-size: 24px;">购物车</h2>
                                <span class="undo" style="font-size: 22px;"><a href="#0">撤回</a></span>
                            </header>

                            <div class="body">
                                <ul>
                                    <!-- products added to the cart will be inserted here using JavaScript -->
                                </ul>
                            </div>

                            <footer style="width:100%">
                                <a id="clearCart" href="#0" class="btn">清空购物车</a>
                                <a href="#0" class="checkout btn settle-account"><em>结算 - ￥<span>0</span></em></a>
                            </footer>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Swiper JS -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/jquery.cookie.js"></script>
        <script src="assets/js/swiper.min.js"></script>
        <script src="assets/js/toast.js"></script>
        <script>
            // swiper
            var swiper = new Swiper('.swiper-container');

            // 购物车
            var cartWrapper = $('.cd-cart-container');
            var cartBody = cartWrapper.find('.body')
            var cartList = cartBody.find('ul').eq(0);
            var cartTotal = cartWrapper.find('.checkout').find('span');
            var cartTrigger = cartWrapper.children('.cd-cart-trigger');
            var cartCount = cartTrigger.children('.count')
            var undo = cartWrapper.find('.undo');
            var settleAccount = cartWrapper.find('.checkout')
            var undoTimeoutId;
            var productId = 0;
            // 存储购物车中的商品
            var cookieCartList = new Array()
            // 用于撤回删除的商品
            var oldCookieCartList = new Array()

            $(function() {
                onLoad();
                bindEvent();
            });
            function onLoad() {
                initPage();
            }
            function initPage() {
                // 初始化购物车
                if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                    var data = JSON.parse($.cookie('cartList'))
                    cookieCartList = data
                    oldCookieCartList = data
                    initCart(data)
                }
            }
            function bindEvent() {
                // 购物车相关事件
                // 添加商品到购物车
                $('.cd-add-to-cart').on('click', function(event){
                    event.preventDefault();
                    addToCart($(this));
                });
                // 打开/关闭购物车
                cartTrigger.on('click', function(event){
                    event.preventDefault();
                    toggleCart();
                });
                // 单击图标关闭购物车
                cartWrapper.on('click', function(event){
                    if( $(event.target).is($(this)) ) toggleCart(true);
                });
                // 从购物车中删除一个商品
                cartList.on('click', '.delete-item', function(event){
                    event.preventDefault();
                    removeProduct($(event.target).parents('.product'));
                    removeCookie($('.delete-item').index(this), 1)
                });
                // 更新购物车中商品的数量
                cartList.on('change', 'select', function(event){
                    quickUpdateCart();
                });
                // 重新添加从购物车中删除的商品
                undo.on('click', 'a', function(event){
                    clearInterval(undoTimeoutId);
                    event.preventDefault();
                    cartList.find('.deleted').addClass('undo-deleted').one('webkitAnimationEnd oanimationend msAnimationEnd animationend', function(){
                        $(this).off('webkitAnimationEnd oanimationend msAnimationEnd animationend').removeClass('deleted undo-deleted').removeAttr('style');
                        quickUpdateCart();
                    });
                    undo.removeClass('visible');
                    // 存储删除前的购物车列表到cookie
                    $.cookie('cartList', JSON.stringify(oldCookieCartList), {expires: 1})
                });
                // 结算
                $('.settle-account').on('click', function() {
                    var list = new Array()
                    $.each(cookieCartList, function(index, item) {
                        list.push(item.id)
                    })

                    // 创建订单
                    $.ajax({
                        url : '/order/manager/create_order',
                        data : {
                           productIdList : JSON.stringify(list)
                        },
                        type : 'POST',
                        dataType:'json',
                        success : function(res) {
                            console.log(res)
                            if (res.success) {
                                var orderId = res.orderId
                                window.location.href = '/fe/productAccount.html?orderId=' + orderId
                            } else {
                                showMessage(res.msg);
                            }
                        },
                        error : function(err) {
                            showMessage("系统正在升级，请稍后重试");
                            console.log(err);
                        }
                    });
                })
                // 清空购物车
                $('#clearCart').on('click', function() {
                    cartList.html('')
                    $.cookie('cartList', null)
                    cookieCartList.length = 0
                    oldCookieCartList.length = 0
                    quickUpdateCart()
                })
            }

            // 购物车相关方法
            function toggleCart(bool) {
                var cartIsOpen = ( typeof bool === 'undefined' ) ? cartWrapper.hasClass('cart-open') : bool;

                if( cartIsOpen ) {
                    cartWrapper.removeClass('cart-open');
                    //reset undo
                    clearInterval(undoTimeoutId);
                    undo.removeClass('visible');
                    cartList.find('.deleted').remove();

                    setTimeout(function(){
                        cartBody.scrollTop(0);
                        //check if cart empty to hide it
                        if( Number(cartCount.find('li').eq(0).text()) == 0) cartWrapper.addClass('empty');
                    }, 500);
                } else {
                    cartWrapper.addClass('cart-open');
                }
            }
            function addToCart(trigger) {
                var cartIsEmpty = cartWrapper.hasClass('empty');
                //update cart product list
                addProduct(trigger);
                //update number of items
                updateCartCount(cartIsEmpty);
                //update total price
                updateCartTotal(trigger.data('price'), true);
                //show cart
                cartWrapper.removeClass('empty');
            }
            function addProduct(trigger) {
                var imgUrl = trigger.data('img');
                var productName = trigger.data('name')
                var productPrice = trigger.data('price')
                productId = productId + 1;
                var productAdded = $(getCartHtml(imgUrl, productName, productPrice));
                cartList.append(productAdded);

                var data = {
                    id : trigger.data('id'),
                    imgUrl : imgUrl,
                    productName : productName,
                    productPrice : productPrice
                }
                addCookie(data, 1)
            }
            function removeProduct(product) {
                clearInterval(undoTimeoutId);
                cartList.find('.deleted').remove();

                var topPosition = product.offset().top - cartBody.children('ul').offset().top ,
//                        productQuantity = Number(product.find('.quantity').find('select').val()),
                        productQuantity = 1,
                        productTotPrice = Number(product.find('.price').text().replace('$', '')) * productQuantity;

                product.css('top', topPosition+'px').addClass('deleted');

                //update items count + total price
                updateCartTotal(productTotPrice, false);
                updateCartCount(true, -productQuantity);
                undo.addClass('visible');

                //wait 8sec before completely remove the item
                undoTimeoutId = setTimeout(function(){
                    undo.removeClass('visible');
                    cartList.find('.deleted').remove();
                }, 8000);
            }
            function quickUpdateCart() {
                var quantity = 0;
                var price = 0;

                cartList.children('li:not(.deleted)').each(function(){
//                    var singleQuantity = Number($(this).find('select').val());
                    var singleQuantity = 1
                    quantity = quantity + singleQuantity;
                    price = price + singleQuantity*Number($(this).find('.price').text().replace('$', ''));
                });

                cartTotal.text(price.toFixed(2));
                cartCount.find('li').eq(0).text(quantity);
                cartCount.find('li').eq(1).text(quantity+1);
            }
            function updateCartCount(emptyCart, quantity) {
                if( typeof quantity === 'undefined' ) {
                    var actual = Number(cartCount.find('li').eq(0).text()) + 1;
                    var next = actual + 1;

                    if( emptyCart ) {
                        cartCount.find('li').eq(0).text(actual);
                        cartCount.find('li').eq(1).text(next);
                    } else {
                        cartCount.addClass('update-count');

                        setTimeout(function() {
                            cartCount.find('li').eq(0).text(actual);
                        }, 150);

                        setTimeout(function() {
                            cartCount.removeClass('update-count');
                        }, 200);

                        setTimeout(function() {
                            cartCount.find('li').eq(1).text(next);
                        }, 230);
                    }
                } else {
                    var actual = Number(cartCount.find('li').eq(0).text()) + quantity;
                    var next = actual + 1;

                    cartCount.find('li').eq(0).text(actual);
                    cartCount.find('li').eq(1).text(next);
                }
            }
            function updateCartTotal(price, bool) {
                bool ? cartTotal.text( (Number(cartTotal.text()) + price).toFixed(2) )  : cartTotal.text( (Number(cartTotal.text()) - price).toFixed(2) );
            }
            function getCartHtml(imgUrl, productName, productPrice) {
                return '<li class="product">' +
                        '<div class="product-image">' +
                        '<a href="#0"><img class="imgUrl" src="' + imgUrl + '" alt="placeholder"></a>' +
                        '</div>' +
                        '<div class="product-details">' +
                        '<h3><a href="#0" class="name">' + productName + '</a></h3>' +
                        '<span class="price">' + productPrice + '</span>' +
                        '<div class="actions"><a href="#0" class="delete-item">Delete</a></div>' +
                        '</div>' +
                        '</li>'
            }
            // 初始化购物车
            function initCart(data) {
                $.each(data, function(index, item) {
                    cartList.append(getCartHtml(item.imgUrl, item.productName, item.productPrice))
                })
                cartWrapper.removeClass('empty')
                quickUpdateCart()
            }
            // 添加到cookie
            function addCookie(data, time) {
                if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                    cookieCartList = JSON.parse($.cookie('cartList'))
                }
                cookieCartList.push(data)
                oldCookieCartList = cookieCartList
                $.cookie('cartList', JSON.stringify(cookieCartList), {expires: time})
            }
            // 从cookie中删除
            function removeCookie(index, time) {
                if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                    cookieCartList = JSON.parse($.cookie('cartList'))
                }
                var list = new Array()
                for (var i = 0; i < cookieCartList.length; i++) {
                    if (i == index) {
                        continue
                    }
                    list.push(cookieCartList[i])
                }
                oldCookieCartList = cookieCartList
                cookieCartList = list
                $.cookie('cartList', JSON.stringify(list), {expires: time})
            }
        </script>
    </body>
</html>