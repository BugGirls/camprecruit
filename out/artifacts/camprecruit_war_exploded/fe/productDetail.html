<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>智能超市终端</title>
        <meta name="keywords" content="index">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="renderer" content="webkit">
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="toTop" content="true">
        <link rel="icon" type="image/png" href="assets/i/favicon.png">
        <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
        <meta name="apple-mobile-web-app-title" content="Amaze UI" />
        <link rel="stylesheet" href="assets/css/amazeui.min.css" />
        <link rel="stylesheet" href="assets/css/admin.css">
        <link rel="stylesheet" href="assets/css/app.css">
        <link rel="stylesheet" href="assets/css/my_cart.css">
        <link rel="stylesheet" href="assets/css/loading.css">
        <style>
            body {
                font-family: 'YouYuan';
            }
            .tpl-page-header-fixed {
                margin-top: 150px;
            }
            .titleBox {
                float:left;
                position:relative;
                left:35%;
                height: 130px;
                line-height: 130px;
            }
            .titleBox p {
                float:left;
                position:relative;
                right:50%;
                color: black;
            }
            ul,li {
                list-style: none;
                margin:0;
                padding:0;
            }
            .bg {
                padding-top: 20px;
                overflow: hidden;
                min-width: 400px;
                box-sizing: border-box;
                background: #fff;
                float: left;
            }
            .bg_left{
                width: 430px;
                height:auto;
                float: left
            }

            .show {
                width: 450px;
                margin-bottom: 10px;
                position: relative;
                border: 1px solid #E8E8E8;
                cursor: move
            }

            .show img {
                width: 450px;
                height: 450px;
            }

            .mask {
                width: 215px;
                height: 215px;
                background: #000;
                filter: Alpha(opacity=50);
                opacity: 0.5;
                position: absolute;
                top: 0;
                left: 0;
                display: none;
            }

            .smallshow {
                width: 100%;
                height: 70px;
                position: relative;
                margin-top: 24px;
                margin-bottom: 44px;
            }

            .smallshow img {
                border-radius: 51%;
                width: 100%;
                border: 1px solid #e8e8e8;
                box-sizing: border-box;
                transition: all 0.5s
            }

            .smallshow > .middle_box {
                margin-left: 20px;
                margin-right: 30px;
                overflow: hidden;
            }

            .smallshow .middle {
                overflow: hidden;
                transition: all 0.5s;
            }

            .smallshow .middle > li {
                width: 100px;
                height: 100px;
                float: left;
                cursor: pointer;
                padding: 0 5px;
            }

            .smallshow > p {
                position: absolute;
                top: 50%;
                width: 22px;
                height: 32px;
                margin-top: -25px;
            }

            .smallshow > .prev {
                left: 0;
                background: url(assets/img/hover-prev.png) no-repeat;
                transition: all 0.5s
            }

            .smallshow > .next {
                right: 47px;
                background: url(assets/img/hover-next.png) no-repeat;
                transition: all 0.5s
            }

            .smallshow > .prev.prevnone {
                left: 0;
                background: url(assets/img/prev.png) no-repeat;
                cursor: not-allowed
            }

            .smallshow > .next.nextnone{right: 47px;background: url(assets/img/next.png) no-repeat;cursor: not-allowed}
            .am-viewport {
                width: 94%;
                margin: 0 auto;
            }
            .returnDiv {
                font-family: Arial,'Times New Roman','Microsoft YaHei',SimHei;
                width: 120px;
                top:20px;
                right:50px;
                position:fixed;
                cursor:pointer;
            }
            .tpl-table-images-content-block {
                float: left;
                margin-left: 50px;
                width:auto;
            }
        </style>
    </head>

    <body data-type="index">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand" style="height: 130px;line-height: 130px;">
                <a href="index.html" class="tpl-logo">
                    <img src="assets/img/logo.png">
                </a>
            </div>

            <div class="titleBox">
                <p class="am-text-xxxl">智能超市终端</p>
            </div>

            <div class="returnDiv">
                <a style="color: black;" href="javascript:history.back(-1)">
                    <span class="am-icon-arrow-left" style="font-size: 30px; margin-top: 10px;"></span>
                    <span style="font-size: 28px;">Return</span>
                </a>
            </div>
        </header>

        <div class="tpl-page-container tpl-page-header-fixed">
            <div class="tpl-portlet-components" style="margin-top: -20px;">
                <div class="am-u-sm-12" id="productDetailDiv">

                </div>
                <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
                <div style="margin-left: 2%;">
                    <h1 style="margin-top: 50px;">猜你喜欢</h1>
                </div>
                <div class="am-slider am-slider-default am-slider-carousel" style="width: 96%;margin: 0 auto;">
                    <ul class="am-slides">
                        <li>
                            <a href="./productDetail.html">
                                <img src="assets/img/img1.png" />
                            </a>
                        </li>
                        <li><img src="assets/img/img2.png" /></li>
                        <li><img src="assets/img/img3.png" /></li>
                        <li><img src="assets/img/img4.png" /></li>
                        <li><img src="assets/img/img5.png" /></li>
                        <li><img src="assets/img/img1.png" /></li>
                        <li><img src="assets/img/img2.png" /></li>
                        <li><img src="assets/img/img3.png" /></li>
                        <li><img src="assets/img/img4.png" /></li>
                        <li><img src="assets/img/img5.png" /></li>
                        <li><img src="assets/img/img6.png" /></li>
                        <li><img src="assets/img/img7.png" /></li>
                        <li><img src="assets/img/img8.png" /></li>
                    </ul>
                </div>
            </div>
            <!--购物车-->
            <div class="cd-cart-container empty">
                <a href="#0" class="cd-cart-trigger" style="background: #fff">
                    Cart
                    <ul class="count">
                        <li>0</li>
                        <li>0</li>
                    </ul>
                </a>

                <div class="cd-cart">
                    <div class="wrapper">
                        <header style="height: 70px; line-height: 70px">
                            <h2 style="font-size: 24px;">购物车</h2>
                            <span class="undo" style="font-size: 22px;"><a href="#0">撤回</a></span>
                        </header>

                        <div class="body" style="margin: 48px 8px 29px;">
                            <ul>
                                <!-- products added to the cart will be inserted here using JavaScript -->
                            </ul>
                        </div>

                        <footer style="width:100%;display: -webkit-box;display: -webkit-flex;display: -ms-flexbox;display: flex;align-items: center">
                            <a id="clearCart" href="#0" class="btn" style="padding: 0 20px;font-size: 2.4rem;background-color: #eee;height: 72px;line-height: 72px;">清空购物车</a>
                            <a href="#0" class="checkout btn settle-account" style="-webkit-box-flex: 1;-webkit-flex: 1;-ms-flex: 1;flex: 1;"><em>结算 - ￥<span>0</span></em></a>
                        </footer>
                    </div>
                </div>
            </div>
        </div>

        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/amazeui.min.js"></script>
        <script src="assets/js/toast.js"></script>
        <script src="assets/js/mag.js"></script> 
        <script src="assets/js/toTop.js"></script>
        <script src="assets/js/jquery.cookie.js"></script>
        <script src="assets/js/loading.js"></script>
        <script>
            // 购物车相关变量
            var cartWrapper = $('.cd-cart-container');
            var cartBody = cartWrapper.find('.body')
            var cartList = cartBody.find('ul').eq(0);
            var cartTotal = cartWrapper.find('.checkout').find('span');
            var cartTrigger = cartWrapper.children('.cd-cart-trigger');
            var cartCount = cartTrigger.children('.count')
            var undo = cartWrapper.find('.undo');
            var settleAccount = cartWrapper.find('.checkout')
            var undoTimeoutId;
            var productId = 0;
            // 存储购物车中的商品
            var cookieCartList = new Array()
            // 用于撤回删除的商品
            var oldCookieCartList = new Array()

            $(function(){
                onLoad()
                bindEvent();
                // 商品图片放大
                var obj = new mag('.show', '.bigshow','.smallshow','.mask','.bigitem');
                obj.init();
            })
            function onLoad() {
                // 初始化页面
                initPage()
                // 猜你喜欢轮播图
                likeCarousel()
            }
            function initPage() {
                loading()
                $.ajax({
                    url : '/sys/productShelf/get_product_shelf_detail_fe',
                    data : {
                        productNo : getUrlParam('productNo')
                    },
                    type : 'POST',
                    dataType:'json',
                    success : function(res) {
                        if (res.success) {
                            var shelf = res.productShelf

                            var productDetailHtml = '<div class="bg">' +
                                    '<div class="show">' +
                                    '<img src="' + shelf.image + '" alt="">' +
                                    '<div class="mask"></div>' +
                                    '</div>' +
                                    '<div class="smallshow">' +
                                    '<div class="middle_box">' +
                                    '<ul class="middle">' +
                                    '<li><img src="' + shelf.image + '" alt=""></li>' +
                                    '<li><img src="' + shelf.image1 + '" alt=""></li>' +
                                    '<li><img src="' + shelf.image2 + '" alt=""></li>' +
                                    '<li><img src="' + shelf.image3 + '" alt=""></li>' +
                                    '</ul>' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="tpl-table-images-content-block">' +
                                    '<div id="productTitle" class="tpl-i-font" style="font-size: 34px;margin-top: 20px;">' + shelf.productName + '</div>' +
                                    '<div id="productSubTitle" class="tpl-i-font" style="min-height: 120px;font-size: 18px;padding-right: 20px;margin-top: 20px;">' + shelf.productSubTitle + '</div>' +
                                    '<div id="productPrice" class="tpl-i-font" style="min-height: 40px;padding-left: 10px;">' +
                                    '<span style="font-size: 26px;color: red;"> ￥' + shelf.salePrice + '</span>' +
                                    '<span class="am-text-warning" style="font-size: 22px;margin-left: 50px;">总销量：' + shelf.salesVolume + '</span>' +
                                    '</div>' +
                                    '<div style="margin-top: 50px;">' +
                                    '<a href="#0" data-no="' + shelf.productNo + '" data-price="' + shelf.salePrice + '" data-img="' + shelf.image + '" data-name="' + shelf.productName + '" class="am-btn am-btn-success am-round cd-add-to-cart" style="height: 40px;float: left;width: 140px;">' +
                                    '<span class="am-icon-shopping-cart"></span> 加入购物车' +
                                    '</a>'+
                                    '</div>' +
                                    '</div>';

                            $('#productDetailDiv').html(productDetailHtml)

                            // 初始化购物车
                            if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                                var data = JSON.parse($.cookie('cartList'))
                                cookieCartList = data
                                oldCookieCartList = data
                                initCart(data)
                            }

                            setTimeout(function() {
                                loaded()
                            }, 1000)
                        } else {
                            showMessage(res.msg)
                        }
                    },
                    error : function(err) {
                        showMessage("系统正在升级，请稍后重试");
                        console.log(err);
                    }
                });
            }
            function likeCarousel() {
                // 猜你喜欢图片轮播
                $('.am-slider').flexslider({
                    animation: "slide",
                    animationLoop: true,// Boolean: 是否循环播放
                    smoothHeight: false,// Boolean: 当 slide 图片比例不一样时："true": 父类自动适应图片高度，"false": 不自动适应，父类高度为图片的最高高度，默认为false
                    slideshow: true,// Boolean：是否自动播放
                    slideshowSpeed: 3000,// Integer: ms 滚动间隔时间
                    animationSpeed: 600,// Integer: ms 动画滚动速度
                    initDelay: 0,// Integer: ms 首次执行动画的延迟
                    pauseOnAction: false,// Boolean: 用户操作时停止自动播放
                    useCSS: true,// Boolean: 是否使用 css3 transition
                    touch: true, // Boolean: 允许触摸屏触摸滑动滑块

                    controlNav: false,// Boolean: 是否创建控制点
                    directionNav: true,// Boolean: 是否创建上/下一个按钮（previous/next）
                    prevText: "上一个",// String: 上一个按钮文字
                    nextText: "下一个",// String: 下一个按钮文字

                    itemWidth: 300,// Integer: slide 宽度，多个同时滚动时设置
                    itemMargin: 20,// Integer: slide 间距
                    minItems: 4,// Integer: 最少显示 slide 数, 与 `itemWidth` 相关
                    maxItems: 6,// Integer: 最多显示 slide 数, 与 `itemWidth` 相关
                    move: 0, // Integer: 一次滚动移动的 slide 数量，0 - 滚动可见的 slide
                    playAfterPaused: 3000,
                });
            }
            function bindEvent() {
                // 购物车相关事件
                // 添加商品到购物车
                $('body').on('click','.cd-add-to-cart',function(event) {
                    event.preventDefault();
                    addToCart($(this));
                });
                // 打开/关闭购物车
                cartTrigger.on('click', function(event){
                    event.preventDefault();
                    toggleCart();
                });
                // 单击图标关闭购物车
                cartWrapper.on('click', function(event){
                    if( $(event.target).is($(this)) ) toggleCart(true);
                });
                // 从购物车中删除一个商品
                cartList.on('click', '.delete-item', function(event){
                    event.preventDefault();
                    removeProduct($(event.target).parents('.product'));
                    removeCookie($('.delete-item').index(this), 1)
                });
                // 更新购物车中商品的数量
                cartList.on('change', 'select', function(event){
                    quickUpdateCart();
                });
                // 重新添加从购物车中删除的商品
                undo.on('click', 'a', function(event){
                    clearInterval(undoTimeoutId);
                    event.preventDefault();
                    cartList.find('.deleted').addClass('undo-deleted').one('webkitAnimationEnd oanimationend msAnimationEnd animationend', function(){
                        $(this).off('webkitAnimationEnd oanimationend msAnimationEnd animationend').removeClass('deleted undo-deleted').removeAttr('style');
                        quickUpdateCart();
                    });
                    undo.removeClass('visible');
                    // 存储删除前的购物车列表到cookie
                    $.cookie('cartList', JSON.stringify(oldCookieCartList), {expires: 1})
                });
                // 结算
                $('body').on('click','.settle-account',function() {
                    var list = new Array()
                    $.each(cookieCartList, function(index, item) {
                        list.push(item.no)
                    })

                    // 创建订单
                    $.ajax({
                        url : '/order/manager/create_order',
                        data : {
                            productNoList : JSON.stringify(list)
                        },
                        type : 'POST',
                        dataType:'json',
                        success : function(res) {
                            console.log(res)
                            if (res.success) {
                                var orderId = res.orderId
                                window.location.href = '/fe/productAccount.html?orderId=' + orderId
                            } else {
                                showMessage(res.msg);
                            }
                        },
                        error : function(err) {
                            showMessage("系统正在升级，请稍后重试");
                            console.log(err);
                        }
                    });
                })
                // 清空购物车
                $('body').on('click','#clearCart',function() {
                    cartList.html('')
                    $.cookie('cartList', null)
                    cookieCartList.length = 0
                    oldCookieCartList.length = 0
                    quickUpdateCart()
                })
            }
            // 购物车相关方法
            function toggleCart(bool) {
                var cartIsOpen = ( typeof bool === 'undefined' ) ? cartWrapper.hasClass('cart-open') : bool;

                if( cartIsOpen ) {
                    cartWrapper.removeClass('cart-open');
                    //reset undo
                    clearInterval(undoTimeoutId);
                    undo.removeClass('visible');
                    cartList.find('.deleted').remove();

                    setTimeout(function(){
                        cartBody.scrollTop(0);
                        //check if cart empty to hide it
                        if( Number(cartCount.find('li').eq(0).text()) == 0) cartWrapper.addClass('empty');
                    }, 500);
                } else {
                    cartWrapper.addClass('cart-open');
                }
            }
            function addToCart(trigger) {
                var cartIsEmpty = cartWrapper.hasClass('empty');
                //update cart product list
                addProduct(trigger);
                //update number of items
                updateCartCount(cartIsEmpty);
                //update total price
                updateCartTotal(trigger.data('price'), true);
                //show cart
                cartWrapper.removeClass('empty');
            }
            function addProduct(trigger) {
                var imgUrl = trigger.data('img');
                var productName = trigger.data('name')
                var productPrice = trigger.data('price')
                productId = productId + 1;
                var productAdded = $(getCartHtml(imgUrl, productName, productPrice));
                cartList.append(productAdded);

                var data = {
                    no : trigger.data('no'),
                    imgUrl : imgUrl,
                    productName : productName,
                    productPrice : productPrice
                }
                addCookie(data, 1)
            }
            function removeProduct(product) {
                clearInterval(undoTimeoutId);
                cartList.find('.deleted').remove();

                var topPosition = product.offset().top - cartBody.children('ul').offset().top ,
//                        productQuantity = Number(product.find('.quantity').find('select').val()),
                        productQuantity = 1,
                        productTotPrice = Number(product.find('.price').text().replace('$', '')) * productQuantity;

                product.css('top', topPosition+'px').addClass('deleted');

                //update items count + total price
                updateCartTotal(productTotPrice, false);
                updateCartCount(true, -productQuantity);
                undo.addClass('visible');

                //wait 8sec before completely remove the item
                undoTimeoutId = setTimeout(function(){
                    undo.removeClass('visible');
                    cartList.find('.deleted').remove();
                }, 8000);
            }
            function quickUpdateCart() {
                var quantity = 0;
                var price = 0;

                cartList.children('li:not(.deleted)').each(function(){
//                    var singleQuantity = Number($(this).find('select').val());
                    var singleQuantity = 1
                    quantity = quantity + singleQuantity;
                    price = price + singleQuantity*Number($(this).find('.price').text().replace('$', ''));
                });

                cartTotal.text(price.toFixed(2));
                cartCount.find('li').eq(0).text(quantity);
                cartCount.find('li').eq(1).text(quantity+1);
            }
            function updateCartCount(emptyCart, quantity) {
                if( typeof quantity === 'undefined' ) {
                    var actual = Number(cartCount.find('li').eq(0).text()) + 1;
                    var next = actual + 1;

                    if( emptyCart ) {
                        cartCount.find('li').eq(0).text(actual);
                        cartCount.find('li').eq(1).text(next);
                    } else {
                        cartCount.addClass('update-count');

                        setTimeout(function() {
                            cartCount.find('li').eq(0).text(actual);
                        }, 150);

                        setTimeout(function() {
                            cartCount.removeClass('update-count');
                        }, 200);

                        setTimeout(function() {
                            cartCount.find('li').eq(1).text(next);
                        }, 230);
                    }
                } else {
                    var actual = Number(cartCount.find('li').eq(0).text()) + quantity;
                    var next = actual + 1;

                    cartCount.find('li').eq(0).text(actual);
                    cartCount.find('li').eq(1).text(next);
                }
            }
            function updateCartTotal(price, bool) {
                bool ? cartTotal.text( (Number(cartTotal.text()) + price).toFixed(2) )  : cartTotal.text( (Number(cartTotal.text()) - price).toFixed(2) );
            }
            function getCartHtml(imgUrl, productName, productPrice) {
                return '<li class="product">' +
                        '<div class="product-image">' +
                        '<a href="#0"><img class="imgUrl" src="' + imgUrl + '" alt="placeholder"></a>' +
                        '</div>' +
                        '<div class="product-details">' +
                        '<h3><a href="#0" class="name">' + productName + '</a></h3>' +
                        '<span class="price">' + productPrice + '</span>' +
                        '<div class="actions"><a href="#0" class="delete-item">Delete</a></div>' +
                        '</div>' +
                        '</li>'
            }
            // 初始化购物车
            function initCart(data) {
                $.each(data, function(index, item) {
                    cartList.append(getCartHtml(item.imgUrl, item.productName, item.productPrice))
                })
                cartWrapper.removeClass('empty')
                quickUpdateCart()
            }
            // 添加到cookie
            function addCookie(data, time) {
                if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                    cookieCartList = JSON.parse($.cookie('cartList'))
                }
                cookieCartList.push(data)
                oldCookieCartList = cookieCartList
                $.cookie('cartList', JSON.stringify(cookieCartList), {expires: time})
            }
            // 从cookie中删除
            function removeCookie(index, time) {
                if ($.cookie('cartList') !== undefined && $.cookie('cartList') != '' && $.cookie('cartList') != 'null') {
                    cookieCartList = JSON.parse($.cookie('cartList'))
                }
                var list = new Array()
                for (var i = 0; i < cookieCartList.length; i++) {
                    if (i == index) {
                        continue
                    }
                    list.push(cookieCartList[i])
                }
                oldCookieCartList = cookieCartList
                cookieCartList = list
                $.cookie('cartList', JSON.stringify(list), {expires: time})
            }
            function getUrlParam(name){
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) {
                    return unescape(r[2]);
                }
                return null;
            }

            // 加载进度提示
            function loading() {
                $('body').loading({
                    loadingWidth:240,
                    title:'请稍等!',
                    name:'test',
                    discription:'正在加载...',
                    direction:'column',
                    type:'origin',
                    originBg:'#71EA71',
                    originDivWidth:40,
                    originDivHeight:40,
                    originWidth:6,
                    originHeight:6,
                    smallLoading:false,
                    loadingBg:'#389A81',
                    loadingMaskBg:'rgba(123,122,222,0.2)'
                });
            }
            function loaded() {
                removeLoading('test');
            }
        </script>
    </body>
</html>