<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>修改门店</title>
        <meta name="keywords" content="index">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="renderer" content="webkit">
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="apple-mobile-web-app-title" content="Amaze UI" />
        <link rel="stylesheet" href="../assets/css/amazeui.min.css" />
        <link rel="stylesheet" href="../assets/css/admin.css">
        <link rel="stylesheet" href="../assets/css/app.css">
        <style>
        	.tpl-portlet-components {
        		margin-top: -12px;
        		border-radius: 10px;
        	}

            .tpl-logo img {
                display: block;
                height: 78px;
                width: auto;
            }
            .showMaterialImage {
                width: 100px;
                cursor: pointer;
                border: 1px solid #eee;
                height: 100px;
                border-radius: 10px;
            }
            .am-popup-bd img {
                cursor: pointer;
                width: 100px;
                border-radius: 10px;
                margin: 5px;
            }
            .am-popup-bd {
                background-color: #fff;
                text-align: center;
            }
            .am-dropdown {
                float: left;
            }
        </style>
    </head>

    <body data-type="generalComponents">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand">
                <a href="javascript:;" class="tpl-logo">
                    <img src="../assets/img/logo.png">
                </a>
            </div>

            <div class="am-collapse am-topbar-collapse" id="topbar-collapse">
                <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list tpl-header-list">
                    <li class="am-hide-sm-only">
                        <a href="javascript:;" id="admin-fullscreen" class="tpl-header-list-link">
                            <span class="am-icon-arrows-alt"></span>
                            <span class="admin-fullText">开启全屏</span>
                        </a>
                    </li>
                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="tpl-header-list-user-nick">禁言小张</span><span class="tpl-header-list-user-ico"> <img src="../assets/img/img1.png"></span>
                        </a>
                        <ul class="am-dropdown-content">
                            <li><a href="#"><span class="am-icon-bell-o"></span> 资料</a></li>
                            <li><a href="#"><span class="am-icon-cog"></span> 设置</a></li>
                            <li><a href="#"><span class="am-icon-power-off"></span> 退出</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </header>

        <div class="tpl-page-container tpl-page-header-fixed">
            <div class="tpl-left-nav tpl-left-nav-hover">
                <div class="tpl-left-nav-title">
                    Amaze UI 列表
                </div>
                <div class="tpl-left-nav-list">
                    <ul class="tpl-left-nav-menu">
                        <li class="tpl-left-nav-item">
                            <a href="materialImage.html" class="nav-link">
                                <i class="am-icon-home"></i>
                                <span>素材管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="poiManager.html" class="nav-link active">
                                <i class="am-icon-home"></i>
                                <span>门店管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="cardManager.html" class="nav-link tpl-left-nav-link-list ">
                                <i class="am-icon-bar-chart"></i>
                                <span>卡券管理</span>
                            </a>
                        </li>
                        <li class="tpl-left-nav-item">
                            <a href="memberCardManager.html" class="nav-link tpl-left-nav-link-list ">
                                <i class="am-icon-bar-chart"></i>
                                <span>会员卡管理</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tpl-content-wrapper">
                <div class="tpl-portlet-components">
                    <div class="tpl-block">
                        <div class="am-g">
                            <div class="tpl-form-body tpl-form-line">
                                <form class="am-form tpl-form-line-form">
                                	<div>必填字段</div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">门店名称 <span class="tpl-form-line-small-title">businessName</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="businessName" type="text" placeholder="输入门店名称" disabled>
                                            <small>门店名称（仅为商户名，如：国美、麦当劳，不应包含地区、地址、分店名等信息，错误示例：北京国美） 不能为空，15个汉字或30个英文字符内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">分店名称 <span class="tpl-form-line-small-title">branchName</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="branchName" type="text" placeholder="输入分店名称" disabled>
                                            <small>分店名称（不应包含地区信息，不应与门店名有重复，错误示例：北京王府井店） 20 个字 以内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">省份 <span class="tpl-form-line-small-title">province</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="province" type="text" placeholder="输入门店所在的省份" disabled>
                                            <small>门店所在的省份（直辖市填城市名,如：北京 市） 10个字 以内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">城市 <span class="tpl-form-line-small-title">city</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="city" type="text" placeholder="输入门店所在的城市" disabled>
                                            <small>门店所在的城市 10个字 以内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
	                                    <label class="am-u-sm-3 am-form-label">地区 <span class="tpl-form-line-small-title">district</span></label>
	                                    <div class="am-u-sm-9">
	                                        <input id="district" type="text" placeholder="请输入门店所在的地区" disabled>
	                                        <small>门店所在地区 10个字 以内</small>
	                                    </div>
	                                </div>
                                    <div class="am-form-group">
	                                    <label class="am-u-sm-3 am-form-label">详细地址 <span class="tpl-form-line-small-title">address</span></label>
	                                    <div class="am-u-sm-9">
	                                        <input id="address" type="text" placeholder="输入门店的详细地址" disabled>
                                            <small>门店所在的详细街道地址（不要填写省市信息）</small>
	                                    </div>
	                                </div>
									<div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">门店电话 <span class="tpl-form-line-small-title">telephone</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="telephone" type="text" placeholder="输入门店的联系电话">
                                            <small>门店的电话（纯数字，区号、分机号均由“-”隔开）</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">门店类型 <span class="tpl-form-line-small-title">categories</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="categories" type="text" placeholder="输入门店的类型" disabled>
                                            <small>门店的类型（不同级分类用“,”隔开，如：美食，川菜，火锅。详细分类参见附件：微信门店类目表）</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">坐标类型 <span class="tpl-form-line-small-title">offsetType</span></label>
                                        <div class="am-u-sm-9">
                                            <select id="offsetType" data-am-selected="{searchBox: 1}" disabled>
                                                <option value="0"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">经度 <span class="tpl-form-line-small-title">longitude</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="longitude" type="text" placeholder="输入门店所在的经度" disabled>
                                            <small>门店所在地理位置的经度</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">纬度 <span class="tpl-form-line-small-title">latitude</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="latitude" type="text" placeholder="输入门店所在的纬度" disabled>
                                            <small>门店所在地理位置的纬度（经纬度均为火星坐标，最好选用腾讯地图标记的坐标）</small>
                                        </div>
                                    </div>

                                    <!-- 非必填字段 -->
	                                <div style="border-top: 1px solid #eee;padding-top: 20px;">非必填字段</div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">图片列表 <span class="tpl-form-line-small-title">photoList</span></label>
                                        <div class="am-u-sm-9">
                                            <div id="showMaterialImage" class="showMaterialImage">
                                                <img id="materialImg" src="" style="width: 100px; border-radius: 10px;" data-am-modal="{target: '#showImagePopup'}" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">推荐品 <span class="tpl-form-line-small-title">recommend</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="recommend" type="text">
                                            <small>推荐品，餐厅可为推荐菜；酒店为推荐套房；景点为推荐游玩景点等，针对自己行业的推荐内容 200字以内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">特色服务 <span class="tpl-form-line-small-title">special</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="special" type="text">
                                            <small>特色服务，如免费wifi，免费停车，送货上门等商户能提供的特色功能或服务</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">商户简介 <span class="tpl-form-line-small-title">introduction</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="introduction" type="text" >
                                            <small>商户简介，主要介绍商户信息等 300字以内</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">营业时间 <span class="tpl-form-line-small-title">openTime</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="openTime" type="text">
                                            <small>营业时间，24 小时制表示，用“-”连接，如 8:00-20:00</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <label class="am-u-sm-3 am-form-label">人均价格 <span class="tpl-form-line-small-title">avgPrice</span></label>
                                        <div class="am-u-sm-9">
                                            <input id="avgPrice" type="number">
                                            <small>人均价格，大于0 的整数</small>
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <div class="am-u-sm-9 am-u-sm-push-3">
                                            <button id="submitBtn" type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success ">修改</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模态弹出框 -->
        <div class="am-popup" id="showImagePopup">
            <div class="am-popup-inner">
                <div class="am-popup-hd">
                    <h4 class="am-popup-title">选择一张素材图片</h4>
                    <span data-am-modal-close class="am-close">&times;</span>
                </div>
                <div class="am-popup-bd" id="selectMaterialImage">

                </div>
            </div>
        </div>

        <script src="../assets/js/jquery.min.js"></script>
        <script src="../assets/js/amazeui.min.js"></script>
        <script src="../assets/js/app.js"></script>
        <script src="../assets/js/toast.js"></script>
        <script type="text/javascript">
            $(function() {
                onLoad();
                bindEvent();
            });
            function onLoad() {
                // 初始化页面
                initPage()
            }
            function initPage() {
                  $.ajax({
                      url : '/wechat/manager/init_update_poi_page',
                      data: {
                          sid: getUrlParam('sid')
                      },
                      type : 'POST',
                      dataType:'json',
                      success : function(res) {
                          console.log(res)
                          var materialImageHtml = ''
                          var offsetTypeHtml = ''
                          if (res.success) {
                              var wechatMaterialImageList = res.wechatMaterialImageList
                              $.each(wechatMaterialImageList, function(index, item) {
                                  materialImageHtml += '<img src="' + item.localImgUrl + '" data-wechatimgurl="' + item.wechatImgUrl + '"/>';
                              })

                              var offsetTypeMap = res.offsetTypeMap
                              $.each(offsetTypeMap, function(key, value) {
                                  offsetTypeHtml += '<option value="' + key + '">' + value + '</option>'
                              })

                              $('#selectMaterialImage').html(materialImageHtml)
                              $('#offsetType').html(offsetTypeHtml)

                              var wechatPoi = res.wechatPoi;
                              $('#businessName').val(wechatPoi.businessName);
                              $('#branchName').val(wechatPoi.branchName)
                              $('#province').val(wechatPoi.province)
                              $('#city').val(wechatPoi.city)
                              $('#district').val(wechatPoi.district)
                              $('#address').val(wechatPoi.address)
                              $('#telephone').val(wechatPoi.telephone)
                              $('#categories').val(wechatPoi.categories)
                              $('#longitude').val(wechatPoi.longitude)
                              $('#latitude').val(wechatPoi.latitude)
                              $('#recommend').val(wechatPoi.recommend)
                              $('#special').val(wechatPoi.special)
                              $('#introduction').val(wechatPoi.introduction)
                              $('#openTime').val(wechatPoi.openTime)
                              $('#avgPrice').val(wechatPoi.avgPrice)
                              $('#offsetType').val(wechatPoi.offsetType)
                              $('#materialImg').attr('src', wechatPoi.photoUrls)
                          } else {
                              console.log(res.msg)
                              showMessage(res.msg)
                          }
                      },
                      error : function(err) {
                          console.log(err)
                          showMessage('系统错误')
                      }
                 });
            }
            function bindEvent() {
                // 模态窗口的弹出
                $('#showMaterialImage').click(function() {
                    $('#showImagePopup').modal();
                })
                // 选择素材图片
                $('body').on('click','#selectMaterialImage img',function() {
                    var imgSrc = $(this).attr('src')
                    var wechatImgUrl = $(this).data('wechatimgurl')
                    $('#materialImg').attr('src', imgSrc)
                    $('#materialImg').data('wechatimgurl', wechatImgUrl)
                    $('#showImagePopup').modal('close')
                })
                // 提交按钮
                $('#submitBtn').on('click', function() {
                    var receiverInfo = getReceiverInfo();
                    if (receiverInfo.status) {
                        $.ajax({
                            url : '/wechat/manager/update_poi',
                            data: JSON.stringify(receiverInfo.wechatPoi),
                            type : 'POST',
                            dataType:'json',
                            contentType:"application/json",
                            success : function(res) {
                                console.log(res)
                                if (res.success) {
                                    showMessage('门店修改成功')
                                } else {
                                    showMessage('门店修改失败：' + res.msg)
                                }
                            },
                            error : function(err) {
                                console.log(err)
                                showMessage('系统错误')
                            }
                        });
                    } else {
                        showMessage(receiverInfo.msg)
                    }
                })
            }
            // 设置时间类型
            function setDateType(dateType, showType) {
                if (dateType === 'time' && showType === 'show') {
                    $('#timeDiv').show()
                } else if (dateType === 'time' && showType === 'hide') {
                    $('#timeDiv').hide()
                } else if (dateType === 'term' && showType === 'show') {
                    $('#termDiv').show()
                } else if (dateType === 'term' && showType === 'hide') {
                    $('#termDiv').hide()
                }
            }
            // 获取表单参数并校验
            function getReceiverInfo() {
                // 存放获取的表单信息
                var receiverInfo = {};
                // 定义返回对象
                var result = {
                    status: false,
                    msg: ''
                };

                // 获取表单数据
                receiverInfo.telephone = $.trim($('#telephone').val())
                receiverInfo.photoUrls = $('#materialImg').data('wechatimgurl')
                receiverInfo.recommend = $.trim($('#recommend').val())
                receiverInfo.special = $.trim($('#special').val())
                receiverInfo.introduction = $.trim($('#introduction').val())
                receiverInfo.openTime = $.trim($('#openTime').val())
                receiverInfo.avgPrice = Number($('#avgPrice').val())

                if (!validate(receiverInfo.telephone, 'require')) {
                    result.msg = '请输入门店的联系电话'
                    return result
                }

                result.wechatPoi = receiverInfo;
                result.status = true;
                result.msg = '验证通过';
                return result;
            }
            // 参数验证方法
            function validate(value, type) {
                var value = $.trim(value);
                // 非空验证
                if ('require' === type) {
                    return !!value;// 如果value为空则返回false，否则返回true
                }
                // 判断是否为数字
                if ('isNumber' === type) {
                    return /^[0-9]+.?[0-9]*$/.test(value);
                }
            }
            function getUrlParam(name){
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) {
                    return unescape(r[2]);
                }
                return null;
            }
        </script>
    </body>
</html>